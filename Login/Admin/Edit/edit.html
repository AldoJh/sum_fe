<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Edit Data Tiang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="bg-red-800 text-white w-64 flex flex-col items-center py-8 relative">
            <div class="profile-pic bg-gray-300 rounded-full w-24 h-24 mb-4"></div>
            <h2 class="text-xl mb-8">SUPER ADMIN</h2>
            <nav class="flex flex-col space-y-4">
                <a class="text-lg" href="admin.html">DASHBOARD</a>
                <a class="text-lg" href="report.html">REPORT</a>       
            </nav>
            <!-- Teks "DASHBOARD ADMIN" yang diputar ke kiri -->
      <div class="absolute top-1/2 left-[90%] transform -translate-x-1/2 -translate-y-1/2 -rotate-90 text-6xl font-extrabold tracking-widest leading-none whitespace-nowrap">
        DATA EDIT TIANG
      </div>

      <!-- Tombol Logout -->
      <div class="mt-auto mb-8">
        <button id="logout-btn" class="bg-white text-green-800 px-4 py-2 rounded-full hover:bg-red-600 hover:text-white transition duration-300">
          LOG OUT
        </button>
      </div>
    </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-2xl font-semibold">Form Edit Data Tiang</h1>
                <button class="btn-back" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
            
                <script>
                    function goBack() {
                        window.location.href = '../admin.html';
                    }
                </script>
            </div>
            <form class="grid grid-cols-2 gap-8" id="formData" enctype="multipart/form-data">
                <div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Kode Tiang :</label>
                        <input type="text" name="kode_tiang" class="w-full border border-gray-300 p-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Gambar :</label>
                        <div class="border border-gray-300 p-2 flex justify-center items-center">
                            <img id="previewImage" class="hidden" alt="Preview" width="200">
                            <input type="file" id="fileInput" class="hidden" onchange="previewSelectedImage(event)">
                            <button type="button" onclick="document.getElementById('fileInput').click()" class="bg-blue-500 text-white py-1 px-3 mt-2 rounded">Choose File</button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Provinsi :</label>
                        <input type="text" name="provinsi" class="w-full border border-gray-300 p-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Kabupaten :</label>
                        <input type="text" name="kabupaten" class="w-full border border-gray-300 p-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Kota:</label>
                        <input type="text" name="kota" class="w-full border border-gray-300 p-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Nama Jalan :</label>
                        <input type="text" name="nama_jalan" class="w-full border border-gray-300 p-2">
                    </div>
                    <div class="mb-4 flex space-x-4">
                        <!-- Kotak Ukuran -->
                        <div class="w-1/2">
                            <label class="block text-gray-700">Ukuran :</label>
                            <input type="text" name="ukuran" class="w-full border border-gray-300 p-2 text-sm">
                        </div>
                    
                        <!-- Kotak Sisi -->
                        <div class="w-1/2">
                            <label class="block text-gray-700">Sisi :</label>
                            <input type="text" name="sisi" class="w-full border border-gray-300 p-2 text-sm">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Jenis :</label>
                        <div class="flex items-center">
                            <input type="radio" name="jenis" class="mr-2" value="billboard"> Billboard
                            <input type="radio" name="jenis" class="ml-4 mr-2" value="baliho"> Baliho
                            <input type="radio" name="jenis" class="ml-4 mr-2" value="videotron"> Videotron
                        </div>
                    </div>
                </div>
                <div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Jenis Lampu :</label>
                        <div class="flex items-center">
                            <input type="radio" name="jenis_lampu" class="mr-2" value="front light"> FrontLight
                            <input type="radio" name="jenis_lampu" class="ml-4 mr-2" value="back light"> BackLight
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Titik Kordinat :</label>
                        <input type="text" name="lat" class="w-full border border-gray-300 p-2">
                        <input type="text" name="long" class="w-full border border-gray-300 p-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Jumlah Kendaraan :</label>
                        <div class="flex items-center">
                            <input type="text" name="jumlah_kendaraan" class="w-1/2 border border-gray-300 p-2">
                            <span class="ml-2">/ Hari</span>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Nama Pemilik Tiang :</label>
                        <input type="text" name="nama_pemilik" class="w-full border border-gray-300 p-2">
                        <input type="text" name="status_sewa" class="w-full border border-gray-300 p-2">
                    </div>
                    </div>
                    <div class="flex justify-center mt-4">
                        <button type="button" class="bg-blue-500 text-white py-2 px-4 rounded-full mr-2" onclick="saveData()">Simpan</button>
                        <button type="button" class="bg-red-500 text-white py-2 px-4 rounded-full" onclick="openCancelPopup()">Batal</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

     <!-- Custom Modal Popup -->
     <div id="cancelPopup" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <p class="text-lg font-semibold mb-4">Anda yakin ingin membatalkan perubahan?</p>
            <div class="flex justify-end">
                <button class="bg-gray-300 text-gray-800 py-2 px-4 rounded-full mr-2" onclick="closeCancelPopup()">Tidak</button>
                <button class="bg-red-500 text-white py-2 px-4 rounded-full" onclick="confirmCancel()">Ya</button>
            </div>
        </div>
    </div>

    <script>
        // Fungsi Logout
        document.getElementById("logout-btn").addEventListener("click", function () {
            alert("Anda telah logout!");
            window.location.href = "/sum_fe/Login/login.html"; // Redirect ke halaman login
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        function openCancelPopup() {
            document.getElementById('cancelPopup').classList.remove('hidden');
        }
        function closeCancelPopup() {
            document.getElementById('cancelPopup').classList.add('hidden');
        }
        function confirmCancel() {
            alert('Perubahan dibatalkan!');
            closeCancelPopup();
            window.location.href = '../admin.html';
        }
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('code');

            function previewSelectedImage(event) {
                const file = event.target.files[0];
                const preview = document.getElementById('previewImage');
            
                if (file) {
                    console.log("Gambar dipilih:", file.name);
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        console.log("Preview gambar diperbarui");
                    };
                    reader.readAsDataURL(file);
                } else {
                    console.log("Tidak ada gambar yang dipilih");
                }
            }
            
            
            
            function fetchData(id) {
                axios.get(`http://localhost:3000/data/id/${id}`)
                    .then(response => {
                        const data = response.data[0];
                        console.log(response.data)
                        
                        // Cek apakah elemen ada sebelum mengubah nilainya dan log jika tidak
                        const kodeTiangInput = document.querySelector('input[name="kode_tiang"]');
                        if (kodeTiangInput) {
                            kodeTiangInput.value = data.kode_tiang;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk kode_tiang');
                        }
        
                        const provinsiInput = document.querySelector('input[name="provinsi"]');
                        if (provinsiInput) {
                            provinsiInput.value = data.provinsi;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk provinsi');
                        }
        
                        const kabupatenInput = document.querySelector('input[name="kabupaten"]');
                        if (kabupatenInput) {
                            kabupatenInput.value = data.kabupaten;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk kabupaten');
                        }
        
                        const kotaInput = document.querySelector('input[name="kota"]');
                        if (kotaInput) {
                            kotaInput.value = data.kota;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk kota');
                        }
        
                        const namaJalanInput = document.querySelector('input[name="nama_jalan"]');
                        if (namaJalanInput) {
                            namaJalanInput.value = data.nama_jalan;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk nama_jalan');
                        }
        
                        const ukuranInput = document.querySelector('input[name="ukuran"]');
                        if (ukuranInput) {
                            ukuranInput.value = data.ukuran;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk ukuran');
                        }
        
                        const sisiInput = document.querySelector('input[name="sisi"]');
                        if (sisiInput) {
                            sisiInput.value = data.sisi;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk sisi');
                        }
        
                        // Jenis radio button
                        const jenisRadio = document.querySelectorAll('input[name="jenis"]');
                        let jenisFound = false;
                        jenisRadio.forEach(radio => {
                            if (radio.value === data.jenis) {
                                radio.checked = true;
                                jenisFound = true;
                            }
                        });
                        if (!jenisFound) {
                            console.log('Jenis tidak ditemukan atau tidak cocok dengan data');
                        }
        
                        // Jenis Lampu radio button
                        const jenisLampuRadio = document.querySelectorAll('input[name="jenis_lampu"]');
                        let jenisLampuFound = false;
                        jenisLampuRadio.forEach(radio => {
                            if (radio.value === data.jenis_lampu) {
                                radio.checked = true;
                                jenisLampuFound = true;
                            }
                        });
                        if (!jenisLampuFound) {
                            console.log('Jenis lampu tidak ditemukan atau tidak cocok dengan data');
                        }
        
                        const latInput = document.querySelector('input[name="lat"]');
                        if (latInput) {
                            latInput.value = data.lat;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk lat');
                        }
        
                        const longInput = document.querySelector('input[name="long"]');
                        if (longInput) {
                            longInput.value = data.long;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk long');
                        }
        
                        const jumlahKendaraanInput = document.querySelector('input[name="jumlah_kendaraan"]');
                        if (jumlahKendaraanInput) {
                            jumlahKendaraanInput.value = data.jumlah_kendaraan;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk jumlah_kendaraan');
                        }
        
                        const namaPemilikInput = document.querySelector('input[name="nama_pemilik"]');
                        if (namaPemilikInput) {
                            namaPemilikInput.value = data.nama_pemilik;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk nama_pemilik');
                        }

                        const satuan_sewa= document.querySelector('input[name="status_sewa"]');
                        if (satuan_sewa) {
                            satuan_sewa.value = data.status_sewa;
                        } else {
                            console.log('Tidak dapat menemukan elemen untuk status_sewa');
                        }
        
                         // Menampilkan gambar jika ada
            const preview = document.getElementById('previewImage');
            if (data.gambar) {
                preview.src = `http://localhost:3000/uploads/${data.gambar}`; // Sesuaikan path
                preview.classList.remove('hidden');
            } else {
                preview.src = "";
                preview.classList.add('hidden');
            }
        
                        
                    })
                    .catch(error => {
                        console.error('Terjadi kesalahan:', error);
                    });
            }
        
            fetchData(id);
        }
        
        function previewSelectedImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('previewImage');
        
            if (file) {
                console.log("Gambar dipilih:", file.name);
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    console.log("Preview gambar diperbarui");
                };
                reader.readAsDataURL(file);
            } else {
                console.log("Tidak ada gambar yang dipilih");
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('code');
        console.log('ID yang akan diperbarui:', id);
        
        function saveData() {
            const formData = new FormData();
            const fileInput = document.getElementById('fileInput');
            
            // Mengumpulkan data selain gambar
            const data = {
                kode_tiang: document.querySelector('input[name="kode_tiang"]').value,
                provinsi: document.querySelector('input[name="provinsi"]').value,
                kabupaten: document.querySelector('input[name="kabupaten"]').value,
                kota: document.querySelector('input[name="kota"]').value,
                nama_jalan: document.querySelector('input[name="nama_jalan"]').value,
                ukuran: document.querySelector('input[name="ukuran"]').value,
                sisi: document.querySelector('input[name="sisi"]').value,
                jenis: document.querySelector('input[name="jenis"]:checked').value,
                jenis_lampu: document.querySelector('input[name="jenis_lampu"]:checked').value,
                lat: document.querySelector('input[name="lat"]').value,
                long: document.querySelector('input[name="long"]').value,
                jumlah_kendaraan: document.querySelector('input[name="jumlah_kendaraan"]').value,
                nama_pemilik: document.querySelector('input[name="nama_pemilik"]').value,
            };
        
            // Mengirim data tanpa gambar
            axios.put(`http://localhost:3000/data/id/${id}`, data)
                .then(response => {
                    console.log('Data berhasil diperbarui', response.data);
                    // Setelah data berhasil diperbarui, kirimkan gambar jika ada
                    if (fileInput.files.length > 0) {
                        const gambarFormData = new FormData();
                        gambarFormData.append('gambar', fileInput.files[0]);
        
                        axios.post(`http://localhost:3000/uploadImage/${id}`, gambarFormData, {
                            headers: { 'Content-Type': 'multipart/form-data' }
                        })
                        .then(response => {
                            console.log('Gambar berhasil diperbarui:', response.data);
                            alert('Data dan gambar berhasil diperbarui!');
                        })
                        .catch(error => {
                            console.error('Error mengunggah gambar:', error);
                            alert('Gagal mengunggah gambar');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error mengupdate data:', error);
                    alert('Gagal mengupdate data');
                });
        }
        
                

        </script>
    
        
    </body>
    </html>
    